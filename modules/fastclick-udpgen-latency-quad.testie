%info
This is not a testie, this is a module to be imported with %import

This will generate UDP traffic using 2 NICs. Packets are expected to come back, and the sum of UDP traffic is accounted for and printed as the RESULT.

%variables
GEN_BURST=32
GEN_FLOWS=128
GEN_LENGTH=64
GEN_TOT=EXPAND( $(( $GEN_BURST * $GEN_FLOWS )) )

%script deps=fastclick sudo=true delay=2
click --dpdk -c 0xf -- PKTGEN_CONFIG

%file PKTGEN_CONFIG
define($IP0 10.0.0.1)
define($IP1 10.0.0.2)

elementclass Generator { $port, $srcmac, $dstmac |
    tdOUT::ToDPDKDevice($port, BLOCKING true);

    adv1 :: FastUDPFlows(RATE 0, LIMIT $GEN_TOT, LENGTH $GEN_LENGTH, SRCETH $srcmac, DSTETH $dstmac, SRCIP $IP1, DSTIP $IP0, FLOWS $GEN_FLOWS, FLOWSIZE $GEN_BURST)
    -> MarkMACHeader
    -> EnsureDPDKBuffer
    -> advq1 :: ReplayUnqueue(STOP -1, QUICK_CLONE true)
    -> sndavg :: AverageCounter()
    -> tdOUT;

    StaticThreadSched(advq1 $port)

    FromDPDKDevice($port, MAC $srcmac, MAXTHREADS 1, VERBOSE 99)
    -> avg :: AverageCounter
    -> Discard
}

gen0 :: Generator(0, ${client:0:mac}, ${server:0:mac})
gen1 :: Generator(1, ${client:1:mac}, ${server:1:mac})
gen2 :: Generator(2, ${client:2:mac}, ${server:2:mac})
gen3 :: Generator(3, ${client:3:mac}, ${server:3:mac})

DriverManager(
    wait 1s,
    write gen0/avg.reset,
    write gen1/avg.reset,
    write gen2/avg.reset,
    write gen3/avg.reset,
    wait 4s,
    print "SAVG0 $(gen0/sndavg.link_rate)",
    print "SAVG1 $(gen1/sndavg.link_rate)",
    print "SAVG2 $(gen2/sndavg.link_rate)",
    print "SAVG3 $(gen3/sndavg.link_rate)",
    print "AVG0 $(gen0/avg.link_rate) $(gen0/avg.count)",
    print "AVG1 $(gen1/avg.link_rate) $(gen1/avg.count)",
    print "AVG1 $(gen2/avg.link_rate) $(gen2/avg.count)",
    print "AVG1 $(gen3/avg.link_rate) $(gen3/avg.count)",
    print "RESULT $(add $(gen0/avg.link_rate) $(gen1/avg.link_rate) $(gen2/avg.link_rate) $(gen3/avg.link_rate))")
