%info
Test throughput through two NICs using DPDK

%require
#Still do nothing
click-buildtool provides dpdk

%config
#Still do nothing
tags=physdual,dpdk,fastclick,sudo

#Grapg title
title='DPDK L2 Fwd test'
#Axis name
axis[0]=Throughput

acceptable=0.001
unacceptable_n_runs=0


%script
click --dpdk -c 0x1 -n 4 -- CONFIG

%file CONFIG
define ($N 10000000)
define ($L 60)

define ($mac0 aa:bb:cc:dd:ee:f0)
define ($mac1 aa:bb:cc:dd:ee:f1)
define ($ip0 10.19.0.1)
define ($ip1 10.19.0.2)

//fd0 :: FromDPDKDevice(0);
td0 :: ToDPDKDevice(0);
fd1 :: FromDPDKDevice(1);
td1 :: ToDPDKDevice(1);


fu0 :: FastUDPFlows(RATE 0, LIMIT $N, LENGTH $L, SRCETH $mac0, DSTETH $mac1, SRCIP $ip0, DSTIP $ip1, FLOWS 1, FLOWSIZE $N)
    -> Unqueue(32)
	-> Counter(COUNT_CALL $N finish.run)
	-> td0;

fu1 :: FastUDPFlows(RATE 0, LIMIT 1, LENGTH $L, SRCETH $mac1, DSTETH $mac0, SRCIP $ip1, DSTIP $ip0, FLOWS 1, FLOWSIZE 1)
    -> Unqueue(1)
	-> td1;

fd1 -> ac :: AverageCounter
    -> Discard;

finish :: Script(TYPE PASSIVE,
			print "RESULT $(ac.link_rate)",
			stop);
