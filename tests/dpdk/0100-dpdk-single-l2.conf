%info
Test throughput through two NICs using DPDK

%config
require_tags={dpdk}

#Grapg title
title=DPDK L2 FastUDPGen + Fwd test
timeout=15

#Axis name
varnames={L:Length,result:Throughput,TXCPU:Transmit CPU,RXCPU:Receive CPU}
n_retry=3
acceptable=0.01

%variables
RXCPU={0,2}
fastregression:RXCPU=2
L=[64*1024]
fastregression:L={64,256,1024}

#Default
TXCPU=0

#Use 0 and 2 to avoid NUMA node change
cpu:TXCPU={0,2}



%script
click -n 4 -c 0xf -- CONFIG || click --dpdk -n 4 -c 0xf -- CONFIG

%file CONFIG
define ($N 10000000)

define ($mac0 aa:bb:cc:dd:ee:f0)
define ($mac1 aa:bb:cc:dd:ee:f1)
define ($ip0 10.19.0.1)
define ($ip1 10.19.0.2)

//fd0 :: FromDPDKDevice(0);
td0 :: ToDPDKDevice(0);
fd1 :: FromDPDKDevice(1);
td1 :: ToDPDKDevice(1);

fu0 :: FastUDPFlows(RATE 0, LIMIT $N, LENGTH $L, SRCETH $mac0, DSTETH $mac1, SRCIP $ip0, DSTIP $ip1, FLOWS 1, FLOWSIZE $N, ACTIVE false)
    -> uq :: Unqueue(32)
    -> td0;
StaticThreadSched(fu0 0)
StaticThreadSched(uq $TXCPU)

fu1 :: FastUDPFlows(RATE 0, LIMIT 1, LENGTH $L, SRCETH $mac1, DSTETH $mac0, SRCIP $ip1, DSTIP $ip0, FLOWS 1, FLOWSIZE 1)
    -> Unqueue(1)
    -> td1;

fd1 -> ac :: AverageCounter
    -> Discard;
StaticThreadSched(fd1 $RXCPU)

finish :: Script(       print "Waiting for link initialization...",
                        wait 2s,
                        print "Launching test !",
                        write ac.reset,
                        write fu0.active true,
                        wait 5s,
                        print "RESULT $(add $(mul $(ac.byte_rate) 8) $(mul $(ac.count) 24))",
                        stop);
